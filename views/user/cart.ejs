<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
    .cart-item { border-bottom: 1px solid #dee2e6; }
    .cart-item img {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 8px;
    }
    .cart-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #212529;
      color: #fff;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 10px;
    }
  </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">BLKND</a>
    <a href="/cart" class="position-relative">
      <i class="fas fa-shopping-cart"></i>
      <span id="cart-count" class="cart-count"><%= cart.totalItems %></span>
    </a>
  </div>
</nav>

<!-- CART -->
<div class="container my-5">
  <div class="row g-4">

    <!-- CART ITEMS -->
    <div class="col-lg-8">

      <% if (!cart || cart.items.length === 0) { %>
        <div class="alert alert-info">Your cart is empty.</div>
      <% } else { %>

        <% cart.items.forEach(item => { %>
          <div class="cart-item py-3" data-item-id="<%= item._id %>">
            <div class="row align-items-center g-3">

              <div class="col-4 col-md-2">
                <img src="<%= item.productId.image[0] %>">
              </div>

              <div class="col-8 col-md-4">
                <h6><%= item.productId.name %></h6>
                <small class="text-muted">
                  Size: <%= item.selectedSize %> |
                  Color: <%= item.selectedColor %>
                </small>
              </div>

              <div class="col-5 col-md-3">
                <div class="input-group input-group-sm">

                  <button
                    class="btn btn-outline-secondary qty-btn"
                    data-id="<%= item._id %>"
                    data-action="decrease"
                    <% if (item.quantity <= 1) { %> disabled <% } %>>
                    −
                  </button>

                  <input
                    class="form-control text-center qty-input"
                    data-item-id="<%= item._id %>"
                    value="<%= item.quantity %>"
                    readonly
                  >

                  <button
                    class="btn btn-outline-secondary qty-btn"
                    data-id="<%= item._id %>"
                    data-action="increase">
                    +
                  </button>

                </div>
              </div>

              <div class="col-3 col-md-1 text-end">
                <button class="btn btn-link text-danger remove-btn" data-id="<%= item._id %>">
                  <i class="fas fa-trash"></i>
                </button>
              </div>

            </div>
          </div>
        <% }) %>

      <% } %>
    </div>

    <!-- SUMMARY -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">

          <h5>Order Summary</h5>

          <div class="d-flex justify-content-between">
            <span>Subtotal</span>
            <span id="subTotal">₹<%= cart.subTotal.toFixed(2) %></span>
          </div>

          <div class="d-flex justify-content-between">
            <span>Tax</span>
            <span id="tax">₹<%= cart.tax.toFixed(2) %></span>
          </div>

          <div class="d-flex justify-content-between">
            <span>Shipping</span>
            <span id="shipping">₹<%= cart.shipping.toFixed(2) %></span>
          </div>

          <hr>

          <div class="d-flex justify-content-between">
            <strong>Total</strong>
            <strong id="total">₹<%= cart.total.toFixed(2) %></strong>
          </div>

          <a href="/checkout" class="btn btn-dark w-100 mt-3">
            Proceed to Checkout
          </a>

        </div>
      </div>
    </div>

  </div>
</div>

<!-- AJAX SCRIPT -->
<script>
document.addEventListener('click', async (e) => {

  const qtyBtn = e.target.closest('.qty-btn');
  const removeBtn = e.target.closest('.remove-btn');

  /* ===== UPDATE QUANTITY ===== */
  if (qtyBtn) {
    const itemId = qtyBtn.dataset.id;
    const action = qtyBtn.dataset.action;

    const res = await fetch(`/cart/update/${itemId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action })
    });

    const data = await res.json();
    if (!data.success) return;

    document.querySelector(
      `.qty-input[data-item-id="${itemId}"]`
    ).value = data.item.quantity;

    updateSummary(data.cart);
  }

  /* ===== REMOVE ITEM ===== */
  if (removeBtn) {
    const itemId = removeBtn.dataset.id;

    const res = await fetch(`/cart/remove/${itemId}`, { method: 'POST' });
    const data = await res.json(); 
    if (!data.success) return;

    document
      .querySelector(`.cart-item[data-item-id="${itemId}"]`)
      .remove();

    updateSummary(data.cart);
  }
});

function updateSummary(cart) {
  document.getElementById('subTotal').innerText = `₹${cart.subTotal.toFixed(2)}`;
  document.getElementById('tax').innerText = `₹${cart.tax.toFixed(2)}`;
  document.getElementById('shipping').innerText = `₹${cart.shipping.toFixed(2)}`;
  document.getElementById('total').innerText = `₹${cart.total.toFixed(2)}`;
  document.getElementById('cart-count').innerText = cart.count;
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - BLKND</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Jost', sans-serif; }
        .page-header { background-color: #f8f9fa; padding: 80px 0 40px; margin-bottom: 60px; }
        /* Style for the address selection cards */
        .address-card { border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .address-card:hover { border-color: #212529; background-color: #f8f9fa; }
        .address-card.selected { border-color: #212529; background-color: #fff; box-shadow: 0 0 0 1px #212529; }
        .form-check-input:checked { background-color: #212529; border-color: #212529; }
    </style>
</head>
<body>

    <!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top"
    style="padding: 20px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    <div class="container">
      <a class="navbar-brand" href="/" style="font-size: 28px; font-weight: 700;">BLKND</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="/index">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/shop">Shop</a></li>
          <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
          <li class="nav-item"><a class="nav-link" href="/contact">Contact</a></li>
        </ul>
        <div class="nav-icons d-flex align-items-center">
          <a href="#" data-bs-toggle="modal" data-bs-target="#searchModal"
            style="color: #212529; font-size: 18px; margin-left: 20px;"><i class="fas fa-search"></i></a>
          <a href="/profile" style="color: #212529; font-size: 18px; margin-left: 20px;"><i class="fas fa-user"></i></a>
          <a href="/wishlist" style="color: #212529; font-size: 18px; margin-left: 20px;"><i
              class="fas fa-heart"></i></a>
          <a href="/cart" style="color: #212529; font-size: 18px; margin-left: 20px; position: relative;">
            <i class="fas fa-shopping-cart"></i>
            <span id="cart-count" class="cart-count">
              <%= cart.totalItems %>
            </span>

          </a>
        </div>
      </div>
    </div>
  </nav>

    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="btn-close float-end" data-bs-dismiss="modal"></button>
                    <div class="mt-4">
                        <input type="search" class="form-control form-control-lg" placeholder="Search products...">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-header">
        <div class="container">
            <h1 class="mb-2">Checkout</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/index" class="text-decoration-none text-muted">Home</a></li>
                    <li class="breadcrumb-item"><a href="/cart" class="text-decoration-none text-muted">Cart</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                </ol>
            </nav>
        </div>
    </div>

    <form action="/placeorder" method="POST" id="checkoutForm">
    <div class="container mb-5">
        <div class="row">
            <div class="col-lg-7">
                
                <% if(addresses && addresses.length > 0) { %>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Select Delivery Address</h5>
                        <div class="row g-3">
                            <% addresses.forEach((addr, index) => { %>
                            <div class="col-md-6">
                                <label class="address-card p-3 w-100 h-100 position-relative">
                                    <input type="radio" name="selectedAddress" value="<%= addr._id %>" class="form-check-input position-absolute top-0 end-0 m-3" <%= index === 0 ? 'checked' : '' %>>
                                    <div class="fw-bold"><%= addr.name %></div>
                                    <small class="text-muted d-block"><%= addr.line1 %> <%= addr.line2 ? ', ' + addr.line2 : '' %></small>
                                    <small class="text-muted d-block"><%= addr.city %>, <%= addr.state %> - <%= addr.pincode %></small>
                                    <small class="text-muted d-block mt-1"><i class="fas fa-phone-alt me-1"></i> <%= addr.phone %></small>
                                </label>
                            </div>
                            <% }) %>
                        </div>
                        
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="selectedAddress" id="addNewAddressRadio" value="new">
                                <label class="form-check-label fw-bold" for="addNewAddressRadio">
                                    Ship to a different address
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <% } %>

                <div class="card mb-4" id="newAddressForm" style="<%= (addresses && addresses.length > 0) ? 'display:none;' : '' %>">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Billing Details</h5>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Full Name *</label>
                                <input type="text" name="name" class="form-control" value="<%= user.name %>" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email Address *</label>
                            <input type="email" name="email" class="form-control" value="<%= user.email %>" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" name="phone" class="form-control" value="<%= user.phoneNumber %>" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Street Address *</label>
                            <input type="text" name="street" class="form-control" placeholder="House number and street name" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">City *</label>
                                <input type="text" name="city" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">State *</label>
                                <select class="form-select" name="state" required>
                                    <option value="">Select State</option>
                                    <option>Kerala</option>
                                    <option>Tamil Nadu</option>
                                    <option>Karnataka</option>
                                    <option>Maharashtra</option>
                                    <option>Delhi</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ZIP Code *</label>
                            <input type="text" name="pincode" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Payment Method</h5>
                        <div class="form-check mb-3">
                            <% if (typeof error !== 'undefined' && error) { %>
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <strong>Error:</strong> <%= error %>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            <% } %>
                            <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="card" checked>
                            <label class="form-check-label" for="creditCard">
                                <i class="fab fa-cc-visa"></i> <i class="fab fa-cc-mastercard"></i> Online Payment / Card
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod">
                            <label class="form-check-label" for="cod">
                                Cash on Delivery
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Order Summary</h5>
                        
                        <div class="border-bottom pb-3 mb-3">
                            <% if(cart && cart.items.length > 0) { %>
                                <% cart.items.forEach(item => { %>
                                    <div class="d-flex justify-content-between mb-3">
                                        <div class="d-flex align-items-center">
                                            <div style="width: 50px; height: 50px; margin-right: 15px; flex-shrink: 0;">
                                                <img src="<%= item.productId.image && item.productId.image[0] ? item.productId.image[0] : '/images/placeholder.png' %>" 
                                                     alt="<%= item.productId.name %>" 
                                                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                                            </div>
                                            <div>
                                                <strong class="d-block" style="font-size: 14px;"><%= item.productId.name %></strong>
                                                <p class="text-muted small mb-0">
                                                    Size: <%= item.selectedSize %> | Qty: <%= item.quantity %>
                                                    <% if (item.selectedColor) { %> | Color: <%= item.selectedColor %> <% } %>
                                                </p>
                                            </div>
                                        </div>
                                        <span class="text-end" style="font-size: 14px;">₹<%= (item.productId.price * item.quantity).toFixed(2) %></span>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>₹<%= cart.subTotal.toFixed(2) %></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span><%= cart.shipping === 0 ? 'Free' : '₹' + cart.shipping %></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax:</span>
                            <span>₹<%= cart.tax.toFixed(2) %></span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-4">
                            <strong>Total:</strong>
                            <strong class="text-primary fs-4">₹<%= cart.total.toFixed(2) %></strong>
                        </div>
                        
                        <button type="submit" class="btn btn-dark w-100 btn-lg">Place Order</button>
                        
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-lock"></i> Secure Checkout
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </form>

    <footer style="background-color: #212529; color: #fff; padding: 60px 0 20px;">
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <h5>BLKND</h5>
                    <p style="color: #adb5bd;">Your premier destination for fashion and style.</p>
                </div>
                <div class="col-md-3">
                    <h5>Quick Links</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li><a href="/about" style="color: #adb5bd; text-decoration: none;">About Us</a></li>
                        <li><a href="/shop" style="color: #adb5bd; text-decoration: none;">Shop</a></li>
                        <li><a href="/contact" style="color: #adb5bd; text-decoration: none;">Contact</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Customer Service</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li><a href="/profile" style="color: #adb5bd; text-decoration: none;">My Account</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Newsletter</h5>
                    <form>
                        <div class="input-group">
                            <input type="email" class="form-control" placeholder="Your email">
                            <button class="btn btn-light" type="submit">Subscribe</button>
                        </div>
                    </form>
                </div>
            </div>
            <hr style="border-color: rgba(255,255,255,0.1); margin: 30px 0;">
            <div class="text-center">
                <p style="color: #adb5bd;">&copy; 2025 BLKND. All rights reserved.</p>
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    const addressRadios = document.querySelectorAll('input[name="selectedAddress"]');
    const newAddressForm = document.getElementById('newAddressForm');
    // Select inputs that should be required ONLY when creating a new address
    const newAddressInputs = newAddressForm.querySelectorAll('input, select, textarea');

    function toggleForm() {
        const addNewAddressRadio = document.getElementById('addNewAddressRadio');
        // Check if "New Address" is selected OR if there are no saved addresses (radios length is 0)
        const isNew = addNewAddressRadio?.checked || addressRadios.length === 0;
        
        if (isNew) {
            newAddressForm.style.display = 'block';
            newAddressInputs.forEach(input => {
                // Don't make Order Notes required, as it is optional
                if (input.name !== 'orderNotes') {
                    input.setAttribute('required', 'true');
                }
            });
        } else {
            newAddressForm.style.display = 'none';
            newAddressInputs.forEach(input => input.removeAttribute('required'));
        }
    }

    // Add event listeners to all radio buttons (Saved addresses + New address option)
    const allRadios = document.querySelectorAll('input[name="selectedAddress"]');
    allRadios.forEach(radio => {
        radio.addEventListener('change', toggleForm);
    });

    toggleForm();
</script>
</body>
</html>